const agencies = [
  {
    agencyName: "Best Deal",
    cash: 1245000,
    credit: 200000,
    agencyId: "Plyq5M5AZ",

    cars: [
      {
        brand: "bmw",
        models: [
          {
            name: "3",
            year: 2015,
            price: 137000,
            carNumber: "AZJZ4",
            ownerId: "Plyq5M5AZ",
          },
          {
            name: "X6",
            year: 2020,
            price: 966500,
            carNumber: "S6DL1",
            ownerId: "Plyq5M5AZ",
          },
        ],
      },
      {
        brand: "toyota",
        models: [
          {
            name: "Land Cruiser",
            year: 2020,
            price: 336300,
            carNumber: "6rvXw",
            ownerId: "Plyq5M5AZ",
          },
          {
            name: "Hilux",
            year: 2005,
            price: 35005,
            carNumber: "MWXBG",
            ownerId: "Plyq5M5AZ",
          },
          {
            name: "Corolla",
            year: 2020,
            price: 111900,
            carNumber: "hCzl-",
            ownerId: "Plyq5M5AZ",
          },
        ],
      },
      {
        brand: "Ford",
        models: [
          {
            name: "Focus",
            year: 2020,
            price: 98200,
            carNumber: "kN3HP",
            ownerId: "Plyq5M5AZ",
          },
          {
            name: "Focus",
            year: 2005,
            price: 6502,
            carNumber: "LJTCs",
            ownerId: "Plyq5M5AZ",
          },
        ],
      },
      {
        brand: "Alpha romeo",
        models: [
          {
            name: "Romeo Julia",
            year: 2020,
            price: 275406,
            carNumber: "2kjy7",
            ownerId: "Plyq5M5AZ",
          },
          {
            name: "Romeo Stelvio",
            year: 2019,
            price: 215403,
            carNumber: "7A5b-",
            ownerId: "Plyq5M5AZ",
          },
        ],
      },
      {
        brand: "Chevrolet",
        models: [
          {
            name: "Traverse",
            year: 2020,
            price: 201102,
            carNumber: "QwBOT",
            ownerId: "Plyq5M5AZ",
          },
          {
            name: "Impala",
            year: 2019,
            price: 165041,
            carNumber: "2v4jt",
            ownerId: "Plyq5M5AZ",
          },
          {
            name: "Malibu",
            year: 2017,
            price: 75405,
            carNumber: "O4_Jv",
            ownerId: "Plyq5M5AZ",
          },
        ],
      },
    ],
  },
  {
    agencyName: "CarMax",
    cash: 968541,
    credit: 500000,
    agencyId: "26_IPfHU1",
    cars: [
      {
        brand: "bmw",
        models: [
          {
            name: "X5",
            year: 2015,
            price: 218000,
            carNumber: "4Ixb0",
            ownerId: "26_IPfHU1",
          },
          {
            name: "X6",
            year: 2014,
            price: 97100,
            carNumber: "kAnv-",
            ownerId: "26_IPfHU1",
          },
          {
            name: "Z4",
            year: 2019,
            price: 296900,
            carNumber: "ISMdU",
            ownerId: "26_IPfHU1",
          },
          {
            name: "3",
            year: 2010,
            price: 75100,
            carNumber: "9DJPw",
            ownerId: "26_IPfHU1",
          },
        ],
      },
      {
        brand: "toyota",
        models: [
          {
            name: "Land Cruiser",
            year: 2005,
            price: 80540,
            carNumber: "Kt-pW",
            ownerId: "26_IPfHU1",
          },
          {
            name: "Corolla",
            year: 2019,
            price: 109100,
            carNumber: "YiYdI",
            ownerId: "26_IPfHU1",
          },
          {
            name: "Hilux",
            year: 2019,
            price: 204000,
            carNumber: "DRmNw",
            ownerId: "26_IPfHU1",
          },
        ],
      },
      {
        brand: "Ford",
        models: [
          {
            name: "F250",
            year: 2020,
            price: 198500,
            carNumber: "g4Wfp",
            ownerId: "26_IPfHU1",
          },
          {
            name: "Explorer",
            year: 2020,
            price: 265200,
            carNumber: "iNT8Q",
            ownerId: "26_IPfHU1",
          },
        ],
      },
      {
        brand: "Alpha romeo",
        models: [
          {
            name: "Spider",
            year: 2011,
            price: 75405,
            carNumber: "6t7QU",
            ownerId: "26_IPfHU1",
          },
          {
            name: "166",
            year: 2002,
            price: 12400,
            carNumber: "XMqpn",
            ownerId: "26_IPfHU1",
          },
        ],
      },
      {
        brand: "Chevrolet",
        models: [
          {
            name: "Impala",
            year: 2016,
            price: 65042,
            carNumber: "vbeAo",
            ownerId: "26_IPfHU1",
          },
          {
            name: "Savannah",
            year: 2016,
            price: 76505,
            carNumber: "WelWa",
            ownerId: "26_IPfHU1",
          },
        ],
      },
    ],
  },
  {
    agencyName: "The Auto World",
    cash: 687450,
    credit: 200000,
    agencyId: "gNHjNFL12",
    cars: [
      {
        brand: "bmw",
        models: [
          {
            name: "X6",
            year: 2018,
            price: 548100,
            carNumber: "EMW_7",
            ownerId: "gNHjNFL12",
          },
          {
            name: "3",
            year: 2017,
            price: 178000,
            carNumber: "XlnB4",
            ownerId: "gNHjNFL12",
          },
        ],
      },
      {
        brand: "toyota",
        models: [
          {
            name: "Prius",
            year: 2017,
            price: 101542,
            carNumber: "-RQgN",
            ownerId: "gNHjNFL12",
          },
          {
            name: "Highlander",
            year: 2017,
            price: 202540,
            carNumber: "AZJZ4",
            ownerId: "gNHjNFL12",
          },
          {
            name: "Corolla",
            year: 1996,
            price: 5420,
            carNumber: "kHE8f",
            ownerId: "gNHjNFL12",
          },
          {
            name: "Corolla",
            year: 2012,
            price: 40570,
            carNumber: "p2qEi",
            ownerId: "gNHjNFL12",
          },
        ],
      },
      {
        brand: "Ford",
        models: [
          {
            name: "Explorer",
            year: 2014,
            price: 127502,
            carNumber: "Ty1zN",
            ownerId: "gNHjNFL12",
          },
          {
            name: "F350",
            year: 2012,
            price: 54250,
            carNumber: "z03H2",
            ownerId: "gNHjNFL12",
          },
        ],
      },
      {
        brand: "Chevrolet",
        models: [
          {
            name: "Savannah",
            year: 2010,
            price: 36504,
            carNumber: "RXFZe",
            ownerId: "gNHjNFL12",
          },
          {
            name: "Malibu",
            year: 2009,
            price: 19585,
            carNumber: "K5IsM",
            ownerId: "gNHjNFL12",
          },
        ],
      },
    ],
  },
  {
    agencyName: "Car Werks",
    cash: 302502,
    credit: 150000,
    agencyId: "9KeaYbRLP",
    cars: [
      {
        brand: "bmw",
        models: [
          {
            name: "8",
            year: 2020,
            price: 942500,
            carNumber: "4IUMz",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "X6",
            year: 2010,
            price: 129000,
            carNumber: "Vw0fV",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "X3",
            year: 2019,
            price: 358100,
            carNumber: "ufN54",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "3",
            year: 2020,
            price: 389100,
            carNumber: "F127X",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "3",
            year: 2002,
            price: 18400,
            carNumber: "ueZUp",
            ownerId: "9KeaYbRLP",
          },
        ],
      },
      {
        brand: "toyota",
        models: [
          {
            name: "Prius",
            year: 2011,
            price: 38520,
            carNumber: "AZJZ4",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "Land Cruiser",
            year: 2019,
            price: 290040,
            carNumber: "AZJZ4",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "Hilux",
            year: 2020,
            price: 215700,
            carNumber: "xig8N",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "Hilux",
            year: 2015,
            price: 178506,
            carNumber: "ghTiQ",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "Corolla",
            year: 2002,
            price: 8504,
            carNumber: "Mvw8T",
            ownerId: "9KeaYbRLP",
          },
        ],
      },
      {
        brand: "Chevrolet",
        models: [
          {
            name: "Impala",
            year: 2005,
            price: 9320,
            carNumber: "BZpkt",
            ownerId: "9KeaYbRLP",
          },
          {
            name: "Malibu",
            year: 2002,
            price: 4502,
            carNumber: "KqKV_",
            ownerId: "9KeaYbRLP",
          },
        ],
      },
    ],
  },
  {
    agencyName: "Carsova",
    cash: 72450,
    credit: 50000,
    agencyId: "oqQmsZoUo",
    cars: [
      {
        brand: "bmw",
        models: [
          {
            name: "7",
            year: 1999,
            price: 24700,
            carNumber: "sZrjp",
            ownerId: "oqQmsZoUo",
          },
          {
            name: "3",
            year: 2008,
            price: 54000,
            carNumber: "da88K",
            ownerId: "oqQmsZoUo",
          },
        ],
      },
      {
        brand: "toyota",
        models: [
          {
            name: "Prius",
            year: 2019,
            price: 124050,
            carNumber: "ZfbqH",
            ownerId: "oqQmsZoUo",
          },
          {
            name: "Hilux",
            year: 1996,
            price: 11540,
            carNumber: "AZJZ4",
            ownerId: "oqQmsZoUo",
          },
        ],
      },
    ],
  },
];

const customers = [
  {
    name: "Lilah Goulding",
    id: "BGzHhjnE8",
    cars: [
      {
        name: "Corolla",
        year: 2013,
        price: 40570,
        carNumber: "16da1",
        ownerId: "BGzHhjnE8",
      },
    ],
    cash: 35000,
  },
  {
    name: "Ravi Murillo",
    id: "2RprZ1dbL",
    cars: [
      {
        name: "M5",
        year: 2019,
        price: 578054,
        carNumber: "WIh0U",
        ownerId: "2RprZ1dbL",
      },
      {
        name: "Spider",
        year: 2012,
        price: 81520,
        carNumber: "RLS4q",
        ownerId: "2RprZ1dbL",
      },
    ],
    cash: 278542,
  },
  {
    name: "Aleksander Carr",
    id: "pAuFtn_WA",
    cars: [
      {
        name: "Highlander",
        year: 2018,
        price: 214503,
        carNumber: "2WU_y",
        ownerId: "pAuFtn_WA",
      },
    ],
    cash: 125402,
  },
  {
    name: "Lana Edge",
    id: "cnTobUDy6",
    cars: [
      {
        name: "F250",
        year: 2020,
        price: 198500,
        carNumber: "Xxcy_",
        ownerId: "cnTobUDy6",
      },
      {
        name: "Hilux",
        year: 2005,
        price: 35005,
        carNumber: "VSCUj",
        ownerId: "cnTobUDy6",
      },
    ],
    cash: 7000,
  },
  {
    name: "Nikita Philip",
    id: "5x2tMcX4R",
    cars: [
      {
        name: "Impala",
        year: 2016,
        price: 65042,
        carNumber: "LKInp",
        ownerId: "5x2tMcX4R",
      },
    ],
    cash: 40541,
  },
  {
    name: "Bob Steel",
    id: "Wm6BkA1F0",
    cars: [],
    cash: 15732,
  },
  {
    name: "Will Reyes",
    id: "FQvNsEwLZ",
    cars: [
      { name: "X6", year: 2020, price: 966500, ownerId: "FQvNsEwLZ" },
      {
        name: "Land Cruiser",
        year: 2020,
        price: 336300,
        carNumber: "vaJvd",
        ownerId: "FQvNsEwLZ",
      },
      {
        name: "Romeo Julia",
        year: 2020,
        price: 275406,
        carNumber: "qLoYR",
        ownerId: "FQvNsEwLZ",
      },
      {
        name: "Explorer",
        year: 2020,
        price: 265200,
        carNumber: "tlGRq",
        ownerId: "FQvNsEwLZ",
      },
    ],
    cash: 1547242,
  },
];

const CarAgencyManager = {
  agencies,

  // Search for a car agency by its name or ID.
  // Search for a car agency by its name or ID.
  // @param {string} idOrName - ID or name of the agency
  // @return {object} - agency object if found, otherwise null
  searchAgency: function (idOrName) {
    const foundAgency = this.agencies.find(
      (agency) => agency.agencyName === idOrName || agency.agencyId === idOrName
    );
    if (foundAgency) {
      return foundAgency;
    } else {
      console.log("Not found agency name or ID, please try again.");
      return null; // I can return any other value indicating the agency is not found
    }
  },
  // Retrieve all agencies' names.
  getAllAgenciesName: function () {
    const agencyNameArr = this.agencies.map((agency) => agency.agencyName);
    return agencyNameArr;
  },
  // Add a new car to an agency's inventory.
  addCarToAgency: function (agencyId, carObject) {
    const agency = this.searchAgency(agencyId);
    if (agency) {
      agency.cars.push(carObject);
    } else {
      console.log(
        `Agency with ID:${agencyId} has not been found, please try again.`
      );
    }
  },
  // Remove a car from an agency's inventory.
  deleteCarFromAgency: function (agencyId, carNumber) {
    const agency = this.searchAgency(agencyId); //finding the agency match
    if (agency) {
      let carFound = false; //used to track whether the car with the given carNumber is found in the agency's inventory.
      agency.cars.forEach((car) => {
        //iterates over each car in the agency's inventory
        const carIndex = car.models.findIndex(
          //matching the car models array of the car to find the index of the model that has a carNumber matching the given carNumber
          (model) => model.carNumber === carNumber
        );
        if (carIndex !== -1) {
          car.models.splice(carIndex, 1); //removes from the model array with carIndex as the starting index and 1 as the number of elements to remove
          carFound = true; //to indicate that the car with the given carNumber is found and removed
        }
      });
      if (carFound) {
        return true; // Car successfully removed
      } else {
        return false; // Car not found in the agency's inventory
      }
    } else {
      return false; // Agency not found
    }
  },
  changeCreditOrCash: function (agencyId, type, amount) {
    const agency = this.searchAgency(agencyId);
    if (agency) {
      if (typeof amount !== "number") {
        console.log("Amount must be a number.");
        return false;
      }
      if (type === "cash") {
        agency.cash += amount;
      } else if (type === "credit") {
        agency.credit += amount;
      } else {
        console.log(`Invalid word. please type 'cash' or 'credit`);
        return false;
      }
      return true;
    } else {
      console.log("Invalid agency Id");
      return false;
    }
  },
  updateCarPrice: function (agencyId, carNumber, newPrice) {
    const agency = this.searchAgency(agencyId);
    if (!agency) return false;

    for (const brand of agency.cars) {
      for (const car of brand.models) {
        if (car.carNumber === carNumber) {
          car.price = newPrice;
          return true;
        }
      }
    }

    return false;
  },
  getTotalAgencyRevenue: function (agencyId) {
    const agency = this.searchAgency(agencyId);
    if (!agency) return 0;

    let revenue = 0;
    for (let brand of agency.cars) {
      for (let model of brand.models) {
        revenue += model.price;
      }
    }
    console.log(revenue);
    return revenue;
  },

  transferCarBetweenAgencies: function (fromAgencyId, toAgencyId, carId) {
    // Find the agency from and to
    const fromAgency = this.searchAgency(fromAgencyId);
    const toAgency = this.searchAgency(toAgencyId);

    // Check if both agencies exist and the carId is valid
    if (!fromAgency || !toAgency || !carId) {
      return false;
    }

    // Find the car in the specific agency
    const carToTransfer = fromAgency.cars.reduce((foundCar, brand) => {
      if (foundCar) return foundCar;
      return brand.models.find((model) => model.carNumber === carId);
    }, null);

    // error handling if the car doesn't exist in the agency
    if (!carToTransfer) {
      return false;
    }

    // Adding the car to new agency
    const targetBrand = toAgency.cars.find(
      (brand) => brand.brand === carToTransfer.brand
    );
    if (targetBrand) {
      targetBrand.models.push(carToTransfer);
    } else {
      toAgency.cars.push({
        brand: carToTransfer.brand,
        models: [carToTransfer],
      });
    }

    // Removing car from pld agency
    const sourceBrand = fromAgency.cars.find(
      (brand) => brand.brand === carToTransfer.brand
    );
    if (sourceBrand) {
      sourceBrand.models = sourceBrand.models.filter(
        (model) => model.carNumber !== carId
      );
    }

    return true; // Car transferred successfully
  },
};

const customerManager = {
  customers,
  // Search for a customer by their name or ID.
  // @param {string} idOrName - ID or name of the customer
  // @return {object} - customer object if found, otherwise null
  searchCustomer: function (idOrName) {
    const foundCustomer = this.customers.find(
      (customer) => customer.name === idOrName || customer.id === idOrName
    );
    if (foundCustomer) {
      return foundCustomer;
    } else {
      console.log("Not found customer name or ID, please try again.");
      return null;
    }
  },
  // Retrieve all customers' names.
  // @return {string[]} - Array of customer names
  getAllCustomers: function () {
    return this.customers.map((customer) => customer.name);
  },
  // Change the cash of a customer.
  // @param {string} customerId - The ID of the customer
  // @param {number} cash - The new cash value
  // @return {boolean} - true if updated successfully, false otherwise
  changeCustomerCash: function (customerId, cash) {
    const customer = this.customers.find(
      (customer) => customer.id === customerId
    );
    console.log(customer);
    if (customer) {
      customer.cash += cash;
      return true;
    } else {
      return false;
    }
  },
  // Calculate the total value of all cars owned by a specific customer.
  // @param {string} customerId - The ID of the customer
  // @return {number} - The total value of cars owned by the customer
  getCustomerTotalCarValue: function (customerId) {
    const customer = this.customers.find(
      (customer) => customer.id === customerId
    );
    if (!customer) {
      return 0;
    }
    let totalCarValue = 0;
    for (let car of customer.cars) {
      totalCarValue += car.price;
    }

    // Return the total car value
    return totalCarValue;
  },
};

const carManager = {
  cars: [],
  getAllCars: function () {
    this.cars = [];
    for (let i = 0; i < agencies.length; i++) {
      for (let j = 0; j < agencies[i].cars.length; j++) {
        for (let k = 0; k < agencies[i].cars[j].models.length; k++) {
          const car = agencies[i].cars[j].models[k];
          car.brand = agencies[i].cars[j].brand;
          this.cars.push(car);
        }
      }
    }
    return this.cars;
  },
  searchCars: function (year, price, brand) {
    return this.cars.filter(function (car) {
      return car.year === year && car.price === price && car.brand === brand;
    });
  },
  // Return the most expensive car available for sale.
  // @return {object} - The most expensive car
  getMostExpensiveCar: function () {
    return this.cars.reduce((prev, curr) =>
      curr.price > prev.price ? curr : prev
    );
  },
  // Return the cheapest car available for sale.
  // @return {object} - The cheapest car
  getCheapestCar: function () {
    return this.cars.reduce((prev, curr) =>
      curr.price < prev.price ? curr : prev
    );
  },
};

const carPurchaseManager = {
  agencies,
  customers,
  taxesAuthority: {
    totalTaxesPaid: 0,
    sumOfAllTransactions: 0,
    numberOfTransactions: 0,
  },

  // Implement a sellCar function that sells a car to a specific customer.
  // @param {string} carId - The ID of the car
  // @param {string} customerId - The ID of the customer
  // @return {boolean} - true if the car was sold successfully, false otherwise
  sellCar: function (carId, customerId) {
    // Find the agency that has the car
    let car, agency;
    for (let a of this.agencies) {
      for (let brand of a.cars) {
        for (let model of brand.models) {
          if (model.carNumber === carId) {
            car = model;
            agency = a;
            break;
          }
        }
        if (car && agency) break;
      }
      if (car && agency) break;
    }

    // If no agency has the car, return false
    if (!agency || !car) {
      console.log("No car or agency found");
      return false;
    }

    // Find the customer
    const customer = this.customers.find((c) => c.id === customerId);

    // If customer doesn't exist, return false
    if (!customer) {
      console.log("No customer found");
      return false;
    }

    // Check if the customer has enough cash
    if (customer.cash < car.price) {
      console.log("Not enough cash");
      return false;
    }

    // Do the transaction operations
    const tax = car.price * 0.17;
    const totalCost = car.price + tax;

    customer.cash -= totalCost; // Subtract the totalCost from the customer's cash
    customer.cars.push(car); // Add the car to the customer's cars array
    agency.cash += car.price; // Increment the agency's cash by the price of the car
    this.taxesAuthority.totalTaxesPaid += tax; // Add the tax to the total taxes paid to the tax authority
    this.taxesAuthority.sumOfAllTransactions += totalCost; // Add the total cost to the sum of all transactions
    this.taxesAuthority.numberOfTransactions += 1; // Increment the number of transactions

    // Remove the car from the agency's cars
    for (let brand of agency.cars) {
      brand.models = brand.models.filter((model) => model.carNumber !== carId);
    }

    // Update the car's ownerId
    car.ownerId = customerId;

    return true;
  },

  // Calculate and return the total revenue of the entire market.
  // @return {number} - The total revenue of the market
  getTotalMarketRevenue: function () {
    let totalRevenue = 0;

    // Loop through agencies and add cash
    this.agencies.forEach((agency) => {
      totalRevenue += agency.cash;
    });

    // Loop through customers and add cash
    this.customers.forEach((customer) => {
      totalRevenue += customer.cash;
    });

    return totalRevenue;
  },
  // I was trying also with reduce method, just for practice:
  getTotalMarketRevenueReduceMethod: function () {
    // Reduce agencies' cash and credit to totalRevenue
    return (
      this.agencies.reduce((acc, agency) => {
        acc + agency.cash;
      }, 0) +
      this.customers.reduce((acc, customer) => {
        acc + customer.cash;
      }, 0)
    );
  },
};
